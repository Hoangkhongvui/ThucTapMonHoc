<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hoàng Food</title>
    <link href='img/favicon.png' rel='icon' type='image/x-icon' />
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/home-responsive.css">
    <link rel="stylesheet" href="css/toast-message.css">
    <link rel="stylesheet" href="font/font-awesome-pro-v6-6.2.0/css/all.min.css"/>
    <style>
        /* Simple chat widget styles */
        .chat-widget {
            position: fixed;
            right: 20px;
            bottom: 20px;
            z-index: 2000;
            font-family: inherit;
        }
        .chat-toggle-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg,#7d49a3,#4b0082 70%);
            color: #fff;
            display:flex;
            align-items:center;
            justify-content:center;
            box-shadow: 0 6px 18px rgba(0,0,0,0.18);
            cursor: pointer;
            border: none;
        }
        .chat-window {
            width: 340px;
            max-width: calc(100vw - 48px);
            height: 460px;
            display: flex;
            flex-direction: column;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            margin-bottom: 12px;
        }
        .chat-header {
            background: linear-gradient(90deg,#7d49a3,#4b0082);
            color: white;
            padding: 12px 14px;
            display:flex;
            align-items:center;
            justify-content:space-between;
        }
        .chat-header .title { font-weight:600; }
        .chat-body { flex:1; display:flex; flex-direction:column; background:#f7f7f8; overflow-y:scroll; }
        .chat-messages { padding: 12px; flex:1; display:flex; flex-direction:column; gap:8px; overflow: auto; }
        .chat-input-row { display:flex; gap:8px; padding:10px; border-top:1px solid #eee; background:#fff; }
        .chat-input-row input[type="text"]{ flex:1; padding:10px 12px; border-radius:8px; border:1px solid #ddd; }
        .chat-input-row button.send-btn{ padding:10px 12px; border-radius:8px; border:none; background:#7d49a3; color:#fff; cursor:pointer; }
        .chat-bubble { max-width:76%; padding:8px 12px; border-radius:12px; display:inline-block; line-height:1.3; }
        .chat-bubble.user { margin-left:auto; background:#ffefdf; color:#111; border-bottom-right-radius:4px; }
        .chat-bubble.bot { margin-right:auto; background:#fff; color:#111; border:1px solid #eee; border-bottom-left-radius:4px; }
        .chat-empty { text-align:center; color:#888; padding:24px 12px; }
    </style>
</head>
<body>
    <header>
        <div class="header-top">
            <div class="container">
                <div class="header-top-left">
                    <ul class="header-top-list">
                        <li><a href=""><i class="fa-regular fa-phone"></i> 0123 456 789 (miễn phí)</a></li>
                        <li><a href=""><i class="fa-light fa-location-dot"></i> Xem vị trí cửa hàng</a></li>
                    </ul>
                </div>
                <div class="header-top-right">
                    <ul class="header-top-list">
                        <li><a href="">Giới thiệu</a></li>
                        <li><a href="">Cửa hàng</a></li>
                        <li><a href="">Chính sách</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="header-middle">
            <div class="container">
                <div class="header-middle-left">
                    <div class="header-logo">
                        <a href="">
                            <img src="img/Hoàng Food (2).png" style="height: 90px;" alt="" class="header-logo-img">
                        </a>
                    </div>
                </div>
                <div class="header-middle-center">
                    <form action="/search" method="GET" class="form-search">
                        <span class="search-btn"><i class="fa-light fa-magnifying-glass"></i></span>
                        <input
                            type="text"
                            name="keyword"
                            class="form-search-input"
                            oninput="searchProducts()"
                            placeholder="Tìm kiếm món ăn...">
                        <button class="filter-btn"><i class="fa-light fa-filter-list"></i><span>Lọc</span></button>
                    </form>
                </div>
                <div class="header-middle-right">
                    <ul class="header-middle-right-list">
                        <li class="header-middle-right-item dnone open" onclick="openSearchMb()">
                            <div class="cart-icon-menu">
                                <i class="fa-light fa-magnifying-glass"></i>
                            </div>
                        </li>
                        <li class="header-middle-right-item close" onclick="closeSearchMb()">
                            <div class="cart-icon-menu">
                                <i class="fa-light fa-circle-xmark"></i>
                            </div>
                        </li>
                        <li class="header-middle-right-item dropdown open">
                            <i class="fa-light fa-user"></i>
                            <div class="auth-container">
                                <% if (typeof user !== 'undefined' && user) { %>
                                    <span class="text-dndk" style="font-size: 16px; font-weight: 500;"><%= user.fullname %></span>
                                    <!-- <span class="text-tk"><%= user.fullname %><i class="fa-sharp fa-solid fa-caret-down"></span> -->
                                <% } else { %>
                                    <span class="text-dndk">Đăng nhập / Đăng ký</span>
                                    <span class="text-tk">Tài khoản <i class="fa-sharp fa-solid fa-caret-down"></i></span>
                                <% } %>
                            </div>
                            <ul class="header-middle-right-menu">
                                <% if (typeof user !== 'undefined' && user) { %>
                                    <% if (user.role == 'admin') { %>
                                        <li><a href="/admin"><i class="fa-light fa-gear"></i> Quản Lý cửa hàng</a></li>
                                    <% } %>
                                    <li><a href="javascript:;" onclick="myAccount()"><i class="fa-light fa-circle-user"></i> Tài khoản của tôi</a></li>
                                    <li><a href="javascript:;" onclick="orderHistory()"><i class="fa-regular fa-bags-shopping"></i> Đơn hàng đã mua</a></li>
                                    <li class="border"><a id="logout" href="/logout"><i class="fa-light fa-right-from-bracket"></i> Đăng xuất</a></li>
                                <% } else { %>
                                    <li><a id="login" href="javascript:;"><i class="fa-light fa-right-to-bracket"></i> Đăng nhập</a></li>
                                    <li><a id="signup" href="javascript:;"><i class="fa-light fa-user-plus"></i> Đăng ký</a></li>
                                <% } %>
                            </ul>
                        </li>
                        <li class="header-middle-right-item open" onclick="openCart()">
                            <div class="cart-icon-menu">
                                <i class="fa-light fa-basket-shopping"></i>
                                <span class="count-product-cart">0</span>
                            </div>
                            <span>Giỏ hàng</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </header>
    <nav class="header-bottom">
        <div class="container">
            <ul class="menu-list">
                <li class="menu-list-item"><a href="" class="menu-link">Trang chủ</a></li>
                <li class="menu-list-item" onclick="showCategory('Món chay')"><a href="javascript:;" class="menu-link">Món chay</a></li>
                <li class="menu-list-item" onclick="showCategory('Món mặn')"><a href="javascript:;" class="menu-link">Món mặn</a></li>
                <li class="menu-list-item" onclick="showCategory('Món lẩu')"><a href="javascript:;" class="menu-link">Món lẩu</a></li>
                <li class="menu-list-item" onclick="showCategory('Món ăn vặt')"><a href="javascript:;" class="menu-link">Món ăn vặt</a></li>
                <li class="menu-list-item" onclick="showCategory('Món tráng miệng')"><a href="javascript:;" class="menu-link">Món tráng miệng</a></li>
                <li class="menu-list-item" onclick="showCategory('Nước uống')"><a href="javascript:;" class="menu-link">Nước uống</a></li>
                <li class="menu-list-item" onclick="showCategory('Món khác')"><a href="javascript:;" class="menu-link">Món khác</a></li>
            </ul>
        </div>
    </nav>
    <div class="advanced-search">
        <div class="container">
            <div class="advanced-search-category">
                <span>Phân loại </span>
                <select name="" id="advanced-search-category-select" onchange="searchProducts()">
                    <option>Tất cả</option>
                    <option>Món chay</option>
                    <option>Món mặn</option>
                    <option>Món lẩu</option>
                    <option>Món ăn vặt</option>
                    <option>Món tráng miệng</option>
                    <option>Nước uống</option>
                </select>
            </div>
            <div class="advanced-search-price">
                <span>Giá từ</span>
                <input type="number" placeholder="tối thiểu" id="min-price" onchange="searchProducts()">
                <span>đến</span>
                <input type="number" placeholder="tối đa" id="max-price" onchange="searchProducts()">
                <button id="advanced-search-price-btn"><i class="fa-light fa-magnifying-glass-dollar"></i></button>
            </div>
            <div class="advanced-search-control">
                <button id="sort-ascending" onclick="searchProducts(1)"><i class="fa-regular fa-arrow-up-short-wide"></i></button>
                <button id="sort-descending" onclick="searchProducts(2)"><i class="fa-regular fa-arrow-down-wide-short"></i></button>
                <button id="reset-search" onclick="searchProducts(0)"><i class="fa-light fa-arrow-rotate-right"></i></button>
                <button onclick="closeSearchAdvanced()"><i class="fa-light fa-xmark"></i></button>
            </div>
        </div>
    </div>
    <main class="main-wrapper">
        <div class="container" id="trangchu">
            <div class="home-slider">
                <img src="img/Panner-Hoangfood.jpeg" alt="">
                <!-- <img src="img/banner-2.png" alt="">
                <img src="img/banner-3.png" alt="">
                <img src="img/banner-4.png" alt="">
                <img src="img/banner-5.png" alt=""> -->
            </div>
            <div class="home-service" id="home-service">
                <div class="home-service-item">
                    <div class="home-service-item-icon">
                        <i class="fa-light fa-person-carry-box"></i>
                    </div>
                    <div class="home-service-item-content">
                        <h4 class="home-service-item-content-h">GIAO HÀNG NHANH</h4>
                        <p class="home-service-item-content-desc">Cho tất cả đơn hàng</p>
                    </div>
                </div>
                <div class="home-service-item">
                    <div class="home-service-item-icon">
                        <i class="fa-light fa-shield-heart"></i>
                    </div>
                    <div class="home-service-item-content">
                        <h4 class="home-service-item-content-h">SẢN PHẨM AN TOÀN</h4>
                        <p class="home-service-item-content-desc">Cam kết chất lượng</p>
                    </div>
                </div>
                <div class="home-service-item">
                    <div class="home-service-item-icon">
                        <i class="fa-light fa-headset"></i>
                    </div>
                    <div class="home-service-item-content">
                        <h4 class="home-service-item-content-h">HỖ TRỢ 24/7</h4>
                        <p class="home-service-item-content-desc">Tất cả ngày trong tuần</p>
                    </div>
                </div>
                <div class="home-service-item">
                    <div class="home-service-item-icon">
                        <i class="fa-light fa-circle-dollar"></i>
                    </div>
                    <div class="home-service-item-content">
                        <h4 class="home-service-item-content-h">HOÀN LẠI TIỀN</h4>
                        <p class="home-service-item-content-desc">Nếu không hài lòng</p>
                    </div>
                </div>
            </div>
            <div class="home-title-block" id="home-title">
                <h2 class="home-title">Khám phá thực đơn của chúng tôi</h2>
            </div>
            <div class="home-products" id="home-products">
                <% if (products.length > 0) { %>
                    <% products.forEach(product => { %>
                        <div class="col-product">
                            <article class="card-product" >
                                <div class="card-header">
                                    <a href="#" class="card-image-link" onclick="">
                                    <img class="card-image" src="<%= product.img %>" alt="${product.title}">
                                    </a>
                                </div>
                                <div class="food-info">
                                    <div class="card-content">
                                        <div class="card-title">
                                            <a href="#" class="card-title-link" onclick=""><%= product.title %></a>
                                        </div>
                                    </div>
                                    <div class="card-footer">
                                        <div class="product-price">
                                            <span class="current-price"><%= helpers.vnd(product.price) %></span>
                                        </div>
                                    <div class="product-buy">
                                        <button onclick="detailProduct(<%= product.id %>)" class="card-button order-item"><i class="fa-regular fa-cart-shopping-fast"></i> Đặt món</button>
                                    </div>
                                </div>
                                </div>
                            </article>
                        </div>
                    <% }) %>
                <% } else { %>
                    <div class="no-result"><div class="no-result-h">Tìm kiếm không có kết quả</div><div class="no-result-p">Xin lỗi, chúng tôi không thể tìm được kết quả hợp với tìm kiếm của bạn</div><div class="no-result-i"><i class="fa-light fa-face-sad-cry"></i></div></div>
                <% } %>
            </div>
            <div class="page-nav">
                <ul class="page-nav-list">
                </ul>
            </div>
        </div>
        <div class="container" id="account-user">
            <div class="main-account">
                <div class="main-account-header">
                    <h3>Thông tin tài khoản của bạn</h3>
                    <p>Quản lý thông tin để bảo mật tài khoản</p>
                </div>
                <div class="main-account-body">
                    <div class="main-account-body-col">
                        <form action="" class="info-user">
                            <div class="form-group">
                                <label for="infoname" class="form-label">Họ và tên</label>
                                <input class="form-control" type="text" name="infoname" id="infoname" placeholder="">
                            </div>
                            <div class="form-group">
                                <label for="infophone" class="form-label">Số điện thoại</label>
                                <input class="form-control" type="text" name="infophone" id="infophone" disabled="true"
                                    placeholder="">
                            </div>
                            <div class="form-group">
                                <label for="infoemail" class="form-label">Email</label>
                                <input class="form-control" type="email" name="infoemail" id="infoemail"
                                    placeholder="Thêm địa chỉ email của bạn">
                                <span class="inforemail-error form-message"></span>
                            </div>
                            <div class="form-group">
                                <label for="infoaddress" class="form-label">Địa chỉ</label>
                                <input class="form-control" type="text" name="infoaddress" id="infoaddress"
                                    placeholder="Thêm địa chỉ giao hàng của bạn">
                            </div>
                        </form>
                    </div>
                    <div class="main-account-body-col">
                        <form action="" class="change-password">
                            <div class="form-group">
                                <label for="" class="form-label w60">Mật khẩu hiện tại</label>
                                <input class="form-control" type="password" name="" id="password-cur-info"
                                    placeholder="Nhập mật khẩu hiện tại">
                                <span class="password-cur-info-error form-message"></span>
                            </div>
                            <div class="form-group">
                                <label for="" class="form-label w60">Mật khẩu mới </label>
                                <input class="form-control" type="password" name="" id="password-after-info"
                                    placeholder="Nhập mật khẩu mới">
                                <span class="password-after-info-error form-message"></span>
                            </div>
                            <div class="form-group">
                                <label for="" class="form-label w60">Xác nhận mật khẩu mới</label>
                                <input class="form-control" type="password" name="" id="password-comfirm-info"
                                    placeholder="Nhập lại mật khẩu mới">
                                <span class="password-after-comfirm-error form-message"></span>
                            </div>
                        </form>
                    </div>
                    <div class="main-account-body-row">
                        <div>
                            <button id="save-info-user" onclick="changeInformation()"><i
                                    class="fa-regular fa-floppy-disk"></i> Lưu thay đổi</button>
                        </div>
                        <div>
                            <button id="save-password" onclick="changePassword()"><i class="fa-regular fa-key"></i> Đổi
                                mật khẩu</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container" id="order-history">
            <div class="main-account">
                <div class="main-account-header">
                    <h3>Quản lý đơn hàng của bạn</h3>
                    <p>Xem chi tiết, trạng thái của những đơn hàng đã đặt.</p>
                </div>
                <div class="main-account-body">
                    <div class="order-history-section">
                    </div>
                </div>
            </div>
        </div>
    </main>
    <div class="modal product-detail">
        <button class="modal-close close-popup"><i class="fa-thin fa-xmark"></i></button>
        <div class="modal-container mdl-cnt" id="product-detail-content">
        </div>
    </div>
    <div class="modal signup-login">
        <div class="modal-container">
            <button class="form-close" onclick="closeModal()"><i class="fa-regular fa-xmark"></i></button>
            <div class="forms mdl-cnt">
                <div class="form-content sign-up">
                    <%- include('../user/register') %>
                </div>
                <div class="form-content login">
                    <%- include('../user/login') %>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-cart">
        <div class="cart-container">
            <div class="cart-header">
                <h3 class="cart-header-title"><i class="fa-regular fa-basket-shopping-simple"></i> Giỏ hàng</h3>
                <button class="cart-close" onclick="closeCart()"><i class="fa-sharp fa-solid fa-xmark"></i></button>
            </div>
            <div class="cart-body">
                <div class="gio-hang-trong">
                    <i class="fa-thin fa-cart-xmark"></i>
                    <p>Không có sản phẩm nào trong giỏ hàng của bạn</p>
                </div>
                <ul class="cart-list">
                </ul>
            </div>
            <div class="cart-footer">
                <div class="cart-total-price">
                    <p class="text-tt">Tổng tiền:</p>
                    <p class="text-price">0đ</p>
                </div>
                <div class="cart-footer-payment">
                    <button class="them-mon"><i class="fa-regular fa-plus"></i> Thêm món</button>
                    <button class="thanh-toan disabled" onclick="if(!this.classList.contains('disabled')) window.location.href='/order/new'">Thanh toán</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal detail-order">
        <div class="modal-container mdl-cnt">
            <h3 class="modal-container-title">Thông tin đơn hàng</h3>
            <button class="form-close" onclick="closeModal()"><i class="fa-regular fa-xmark"></i></button>
            <div class="detail-order-content">
            </div>
        </div>
    </div>
    <footer class="footer">
        <div class="container">
            <div class="footer-top">
                <div class="footer-top-content">
                    <div class="footer-top-img">
                        <img src="img/logo-footer.png" alt="">
                    </div>
                    <div class="footer-top-subbox">
                        <div class="footer-top-subs">
                            <h2 class="footer-top-subs-title">Đăng ký nhận tin</h2>
                            <p class="footer-top-subs-text">Nhận thông tin mới nhất từ chúng tôi</p>
                        </div>
                        <form class="form-ground">
                            <input type="email" class="form-ground-input" placeholder="Nhập email của bạn">
                            <button class="form-ground-btn">
                                <span>ĐĂNG KÝ</span>
                                <i class="fa-solid fa-arrow-right"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="widget-area">
            <div class="container">
                <div class="widget-row">
                    <div class="widget-row-col-1">
                        <h3 class="widget-title">Về chúng tôi</h3>
                        <div class="widget-row-col-content">
                            <p>Hoàng Food là thương hiệu được thành lập vào năm 2025 với tiêu chí đặt chất lượng sản phẩm lên hàng đầu.</p>
                        </div>
                        <div class="widget-social">
                            <div class="widget-social-item">
                                <a href="">
                                    <i class="fab fa-facebook-f"></i>
                                </a>
                            </div>
                            <div class="widget-social-item">
                                <a href="">
                                    <i class="fab fa-twitter"></i>
                                </a>
                            </div>
                            <div class="widget-social-item">
                                <a href="">
                                    <i class="fab fa-linkedin-in"></i>
                                </a>
                            </div>
                            <div class="widget-social-item">
                                <a href="">
                                    <i class="fab fa-whatsapp"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="widget-row-col">
                        <h3 class="widget-title">Liên kết</h3>
                        <ul class="widget-contact">
                            <li class="widget-contact-item">
                                <a href="">
                                    <i class="fa-regular fa-arrow-right"></i>
                                    <span>Về chúng tôi</span>
                                </a>
                            </li>
                            <li class="widget-contact-item">
                                <a href="">
                                    <i class="fa-regular fa-arrow-right"></i>
                                    <span>Thực đơn</span>
                                </a>
                            </li>
                            <li class="widget-contact-item">
                                <a href="">
                                    <i class="fa-regular fa-arrow-right"></i>
                                    <span>Điều khoản</span>
                                </a>
                            </li>
                            <li class="widget-contact-item">
                                <a href="">
                                    <i class="fa-regular fa-arrow-right"></i>
                                    <span>Liên hệ</span>
                                </a>
                            </li>
                            <li class="widget-contact-item">
                                <a href="">
                                    <i class="fa-regular fa-arrow-right"></i>
                                    <span>Tin tức</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div class="widget-row-col">
                        <h3 class="widget-title">Thực đơn</h3>
                        <ul class="widget-contact">
                            <li class="widget-contact-item">
                                <a href="">
                                    <i class="fa-regular fa-arrow-right"></i>
                                    <span>Điểm tâm</span>
                                </a>
                            </li>
                            <li class="widget-contact-item">
                                <a href="">
                                    <i class="fa-regular fa-arrow-right"></i>
                                    <span>Món chay</span>
                                </a>
                            </li>
                            <li class="widget-contact-item">
                                <a href="">
                                    <i class="fa-regular fa-arrow-right"></i>
                                    <span>Món mặn</span>
                                </a>
                            </li>
                            <li class="widget-contact-item">
                                <a href="">
                                    <i class="fa-regular fa-arrow-right"></i>
                                    <span>Nước uống</span>
                                </a>
                            </li>
                            <li class="widget-contact-item">
                                <a href="">
                                    <i class="fa-regular fa-arrow-right"></i>
                                    <span>Tráng miệng</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div class="widget-row-col-1">
                        <h3 class="widget-title">Liên hệ</h3>
                        <div class="contact">
                            <div class="contact-item">
                                <div class="contact-item-icon">
                                    <i class="fa-regular fa-location-dot"></i>
                                </div>
                                <div class="contact-content">
                                    <span>234 Hoàng Quốc Việt , Bắc Từ Liêm , Tp.Hà Nội</span>
                                </div>
                            </div>
                            <div class="contact-item">
                                <div class="contact-item-icon">
                                    <i class="fa-regular fa-phone"></i>
                                </div>
                                <div class="contact-content contact-item-phone">
                                    <span>0123 456 789</span>
                                    <br>
                                    <span>0987 666 1111</span>
                                </div>
                            </div>
                            <div class="contact-item">
                                <div class="contact-item-icon">
                                    <i class="fa-regular fa-envelope"></i>
                                </div>
                                <div class="contact-content conatct-item-email">
                                    <span>abc@gmail.com</span><br />
                                    <span>hoang@gmail.com</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    <div class="copyright-wrap">
        <div class="container">
            <div class="copyright-content">
                <p>Copyright Hoàng Food 1306</p>
            </div>
        </div>
    </div>
    <div class="back-to-top">
        <a href="#"><i class="fa-regular fa-arrow-up"></i></a>
    </div>
    <div id="toast"></div>
    <!-- Chat widget -->
    <div class="chat-widget" aria-live="polite">
        <div class="chat-window" id="chatWindow" style="display:none;">
            <div class="chat-header">
                <div class="title">Hoàng Food - Trợ lý ảo</div>
                <button id="chatCloseBtn" aria-label="Đóng chat" style="background:transparent;border:none;color:rgba(255,255,255,0.95);font-size:18px;cursor:pointer">&times;</button>
            </div>
            <div class="chat-body">
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-empty">Chào bạn! Hãy nhập câu hỏi hoặc chọn món ăn bạn muốn.</div>
                </div>
                <div class="chat-input-row">
                    <input type="text" id="chatInput" placeholder="Nhập tin nhắn..." aria-label="Nhập tin nhắn">
                    <button class="send-btn" id="chatSendBtn">Gửi</button>
                </div>
            </div>
        </div>
        <button class="chat-toggle-btn" id="chatToggle" aria-label="Mở chat"><i class="fa-solid fa-comment-dots"></i></button>
    </div>
    <script>
        window.products = <%- JSON.stringify(products) %>;
        window.user = <%- JSON.stringify(user || null) %>;
    </script>
    <script src="js/helpers.js"></script>
    <script src="js/pagination.js"></script>
    <script src="js/popup.js"></script>
    <script src="js/login_form.js"></script>
    <script src="js/main.js"></script>
    <script>
        // Chat widget behavior (client-side only)
        (function(){
            function by(id){return document.getElementById(id)}
            var toggle = by('chatToggle');
            var windowEl = by('chatWindow');
            var closeBtn = by('chatCloseBtn');
            var sendBtn = by('chatSendBtn');
            var input = by('chatInput');
            var messages = by('chatMessages');

            function scrollToBottom(){ messages.scrollTop = messages.scrollHeight; }

            function openChat(){ windowEl.style.display = 'flex'; toggle.style.display = 'none'; scrollToBottom(); }
            function closeChat(){ windowEl.style.display = 'none'; toggle.style.display = 'flex'; }

            function appendMessage(kind, text){
                // remove empty hint if present
                var empty = messages.querySelector('.chat-empty');
                if(empty) empty.remove();

                var wrap = document.createElement('div');
                wrap.className = 'chat-bubble ' + (kind === 'user' ? 'user' : 'bot');
                wrap.textContent = text;
                messages.appendChild(wrap);
                scrollToBottom();
            }

            async function simulateBotReply(userText){
                // show a pending/loading message
                var pending = document.createElement('div');
                pending.className = 'chat-bubble bot pending';
                pending.textContent = 'Đang trả lời...';
                var empty = messages.querySelector('.chat-empty'); if(empty) empty.remove();
                messages.appendChild(pending);
                scrollToBottom();

                try {
                    var res = await fetch('/chatbot', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: userText })
                    });

                    if(!res.ok){
                        throw new Error('Network response was not ok');
                    }

                    var data = await res.json();

                    // remove pending element
                    pending.remove();

                    // Prefer the AI's advice summary if present
                    if(data && data.advice && data.advice.summary){
                        appendMessage('bot', data.advice.summary);
                    }

                    // If recommendations exist, list them
                    if(data && data.advice && Array.isArray(data.advice.recommendations) && data.advice.recommendations.length > 0){
                        data.advice.recommendations.forEach(function(rec){
                            var text = '';
                            if(rec.productName) text += rec.productName + (rec.reason ? ': ' + rec.reason : '');
                            else if(rec.reason) text = rec.reason;
                            if(text) appendMessage('bot', text);
                        });
                    }

                    // Fallback: if controller returned products but no advice, show first few product names
                    if((!data.advice || (!data.advice.summary && (!data.advice.recommendations || data.advice.recommendations.length===0))) && data.products && data.products.length>0){
                        var names = data.products.slice(0,3).map(p=>p.title || p.name || p.productName).filter(Boolean);
                        if(names.length) appendMessage('bot', 'Gợi ý: ' + names.join(' — '));
                    }

                    // Final fallback message
                    if((!data || (!data.advice && (!data.products || data.products.length===0)))){
                        appendMessage('bot', 'Xin lỗi, tôi chưa thể trả lời yêu cầu này lúc này.');
                    }

                } catch (err) {
                    pending.remove();
                    console.error('Chatbot error:', err);
                    appendMessage('bot', 'Không thể kết nối đến chatbot. Vui lòng thử lại sau.');
                }
            }

            function send(){
                var val = input.value;
                if(!val || !val.trim()) return;
                appendMessage('user', val.trim());
                input.value = '';
                simulateBotReply(val);
            }

            toggle && toggle.addEventListener('click', openChat);
            closeBtn && closeBtn.addEventListener('click', closeChat);
            sendBtn && sendBtn.addEventListener('click', send);
            input && input.addEventListener('keydown', function(e){ if(e.key === 'Enter'){ e.preventDefault(); send(); } });

            // optional: show greeting on load if user present
            document.addEventListener('DOMContentLoaded', function(){
                // nothing automatically opens; keep collapsed
            });
        })();
    </script>

    <!-- <script src="./js/initialization.js"></script> -->
    <!-- <script src="./js/main.js"></script> -->
    <!-- <script src="./js/checkout.js"></script> -->
    <!-- <script src="./js/toast-message.js"></script> -->
</body>
</html>